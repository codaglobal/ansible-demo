pipeline {
    environment {
            def mvnHome = tool 'M3'
            }
    agent {
        kubernetes {
            label "demo-app-${BUILD_NUMBER}"
            defaultContainer 'jnlp'
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: maven-npm
    image: sponmuth/maven-npm:latest
    command: ['cat']
    tty: true
  resources:
    requests:
      memory: "1024Mi"
      cpu: "300m"
    limits:
      memory: "1024Mi"
      cpu: "300m"
"""
        }
    }
    stages {
                stage('Upload') { 
            steps {
            container('maven-npm') {
               script {
            withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 'AWS', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) 
       {
        sh '''
        export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
        export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
        aws s3 cp s3://webinar-jenkins-test/ss.pem ss.pem --recursive
        ls
        pwd
        ll
        chmod 644 ss.pem
        ll'''
        } 
                     }
               }
            }
        }
    }
}
