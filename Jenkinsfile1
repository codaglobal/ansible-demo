#!/usr/bin/env groovy

pipeline {
environment {
def mvnHome = tool 'M3'
   }
    agent any 
    stages {
        stage('Build') { 
            steps {
        git {
            wipeOutWorkspace(true)
            shallowClone(true);
            remote {
                url("https://github.com/codaglobal/ansible-demo.git")
                relativeTargetDir('checkout-folder')
        }
    }
    git 'https://github.com/codaglobal/ansible-demo.git'
    sh '''
    mvn -f /var/lib/jenkins/workspace/webinar/sample-app/middleware/FamousQuotes/pom.xml clean install
    cd /var/lib/jenkins/workspace/webinar/sample-app/frontend/frontend
    npm install
    npm run-script build''' 
            }
        }
        stage('Upload') { 
            steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 'AWS', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) 
       {
        sh '''
        export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
        export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
        aws s3 sync  /var/lib/jenkins/workspace/webinar/sample-app/frontend/frontend/dist/frontend s3://webinar-jenkins/frontend
        aws s3 sync /var/lib/jenkins/workspace/webinar/sample-app/nginx/ s3://webinar-jenkins
        aws s3 cp /var/lib/jenkins/workspace/webinar/sample-app/middleware/FamousQuotes/target/FamousQuotes-1.0-SNAPSHOT.war s3://webinar-jenkins
        aws s3 cp /var/lib/jenkins/workspace/webinar/sample-app/database/famous-qoutes-schema-setup-5.7.sql s3://webinar-jenkins'''
        }        
            }
        }
        
    }
}
